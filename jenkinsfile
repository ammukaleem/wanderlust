pipeline{
    agent any
    environment {
    SONAR_HOME= tool "sonarqube"
    }
    stages{
        
        stage("Code from Github Account") {
            steps{
            git url: "https://github.com/ammukaleem/wanderlust.git", branch: "devops-cicd"   
            }
        }
        
        stage("SonarQube Analysys") {
            steps{
                withSonarQubeEnv("sonarqube"){
                sh "$SONAR_HOME/bin/sonar-scanner -Dsonar.projectName=wanderlust -Dsonar.projectKey=wanderlust"
                }
            }
         }
         stage("owasp") {
             steps{
                 dependencyCheck additionalArguments: '--scan ./', odcInstallation: "dc"
                 dependencyCheckPublisher pattern: '**/dependency-report.xml'
             }
         }
         stage("sonar quality gate check") {
             steps{
                 timeout(time: 2, unit: 'MINUTES'){
                     waitForQualityGate abortPipeline=false
                 }
                    
             }
         }
         stage("trivy file scan") {
             steps{
                 sh "trivy fs --format table -o trivy-file-systemscan.html ."
             }
         }
         stage("Deploy") {
             steps{
                 sh "docker compose up -d"
             }
         }
	stage("Adding fetured posts"){
	   steps{
		sh "docker exec -it mongodb mongoimport --db wanderlust --collection posts --file ./data/sample_posts.json --jsonArray"
	   }
	}

    }

}

